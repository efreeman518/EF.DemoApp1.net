# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build SampleApp.UI

on:
  # push:
  #   branches:
  #     - main

  workflow_dispatch:
    # inputs:
    #   environment:
    #     type: choice
    #     description: Select environment
    #     required: true
    #     options:
    #       - dev
    #       - prod

env:
  DOTNET_VERSION: '9.x'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      build-run-id: ${{ steps.upload-artifact.outputs.run-id }}
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore ./SampleApp.UI1/SampleApp.UI1.csproj

      - name: Remove environment-only config files
        run: |
          rm -f ./SampleApp.UI1/wwwroot/appsettings.Development.json

      - name: Replace environment-specific appsettings.json placeholders
        run: |
          sed -i "s#__SETTINGS_AZUREB2C_CLIENTID__#${{ vars.SETTINGS_AZUREB2C_CLIENTID }}#g" ./SampleApp.UI1/wwwroot/appsettings.json
          sed -i "s#__SETTINGS_GATEWAY_BASEURL__#${{ vars.SETTINGS_GATEWAY_BASEURL }}#g" ./SampleApp.UI1/wwwroot/appsettings.json
          sed -i "s#__SETTINGS_GATEWAY_SCOPE1__#${{ vars.SETTINGS_GATEWAY_SCOPE1 }}#g" ./SampleApp.UI1/wwwroot/appsettings.json

      - name: Publish (includes build)
        run: dotnet publish ./SampleApp.UI1/SampleApp.UI1.csproj -c Release -o publish --no-restore

      - name: Zip published wwwroot
        run: |
          cd publish/wwwroot
          zip -r ../../artifact.zip .
          cd ../..

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: artifact.zip
      