# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build SampleApp.UI

on:
  # push:
  #   branches:
  #     - main

  workflow_dispatch:
    # inputs:
    #   environment:
    #     type: choice
    #     description: Select environment
    #     required: true
    #     options:
    #       - dev
    #       - prod

env:
  DOTNET_VERSION: '9.x'

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      build-run-id: ${{ steps.upload-artifact.outputs.run-id }}
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore ./SampleApp.UI1/SampleApp.UI1.csproj

      - name: Publish (includes build)
        run: dotnet publish ./SampleApp.UI1/SampleApp.UI1.csproj -c Release -o publish --no-restore

      # - name: Remove environment-specific and compressed config files, leaving only appsettings.json for transform in the deploy job
      #   run: |
      #     #delete compressed appsettings versions
      #     rm -f ./publish/wwwroot/appsettings.json
      #     rm -f ./publish/wwwroot/appsettings.json.gz
      #     rm -f ./publish/wwwroot/appsettings.json.br
      #     rm -f ./publish/wwwroot/_framework/appsettings.json.gz
      #     rm -f ./publish/wwwroot/_framework/appsettings.json.br
      #     #delete environment based appsettings files
      #     rm -f ./publish/wwwroot/appsettings.*.json
      #     rm -f ./publish/wwwroot/appsettings.*.json.gz
      #     rm -f ./publish/wwwroot/appsettings.*.json.br
      #     rm -f ./publish/wwwroot/_framework/appsettings.*.json
      #     rm -f ./publish/wwwroot/_framework/appsettings.*.json.gz
      #     rm -f ./publish/wwwroot/_framework/appsettings.*.json.br

      - name: Copy appsettings.json after publish
        run: cp ./SampleApp.UI1/wwwroot/appsettings.json publish/wwwroot/appsettings.json

      # - name: List publish folder contents
      #   run: ls -R publish

      - name: Zip published wwwroot
        run: |
          cd publish/wwwroot
          zip -r ../../artifact.zip .
          cd ../..

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: artifact.zip
      